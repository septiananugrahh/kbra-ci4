name: CI4 CI/CD

on:
  push:
    branches: ["main"]

jobs:
  ci4-deploy:
    if: contains(github.event.head_commit.message, '[deploy]')
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      # Setup PH
      - uses: shivammathur/setup-php@15c43e89cdef867065b0213be354c2841860869e
        with:
          php-version: "8.3"

      - name: Siapkan file Private untuk deploy (tanpa index.php dan .env)
        run: |
          mkdir .deploy_private
          rsync -av --exclude='index.php' --exclude='.env' ./ .deploy_private/

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy via rsync (password auth)
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
          rsync -avzr \
            --delete \
            -e "ssh -p 18765 -o StrictHostKeyChecking=no" \
            .deploy_private/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/www/kbra.saicponorogo.com/kbra
